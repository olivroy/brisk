---
output: github_document
editor_options: 
  chunk_output_type: console
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# brisk

<!-- badges: start -->
[![R-CMD-check](https://github.com/rich-payne/brisk/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/rich-payne/brisk/actions/workflows/R-CMD-check.yaml)
[![cover](https://github.com/rich-payne/brisk/actions/workflows/cover.yaml/badge.svg)](https://github.com/rich-payne/brisk/actions/workflows/cover.yaml)
[![lint](https://github.com/rich-payne/brisk/actions/workflows/lint.yaml/badge.svg)](https://github.com/rich-payne/brisk/actions/workflows/lint.yaml)
<!-- badges: end -->

The goal of `brisk` is to provide general helper functions to perform quantitative *B*ayesian benefit-*risk* (brisk) analyses.  The original idea of `brisk` is to provide functions which are completely separate from the Bayesian analyses.  The functions in `brisk` are intended to take samples from Bayesian posteriors as inputs, allowing users to employ whatever custom analyses are appropriate.  The posteriors are then combined with utility functions and weights to provide a quantitative benefit risk analysis.

# Example

For each benefit or risk, a weight and utility function are specified.  The utility function takes parameter values as inputs and outputs utility values.  For a given set of parameter values for each benefit and risk, the benefit-risk score can be calculated by taking a weighted average of the utility functions.  Incorporating uncertainty into the estimate through a Bayesian posterior, then yields a posterior distribution on the benefit-risk score.

Benefits and risks are specified in `brisk` using the `benefit()` and `risk()` functions.  These functions require the name of the benefit/risk, a utility function, and a weight.  These utility functions and weights are then combined with samples from the posterior distributions of different groups through the `br_group()` function.

Suppose we have a new treatment that is being tested against a placebo for a particular disease.  For this population of patients, it is determined that a response in less than 50% of patients is not very beneficial, but, above 50% response rate, there is a consistently higher benefit.  Therefore a utility function is constructed to quantify this belief (higher values are better):

```{r}
benefit_fun <- approxfun(c(0, 0.5, 1), c(0, 0.2, 1))
curve(benefit_fun, xlab = "Response Rate", ylab = "Benefit Utility Function")
```

The drug is also believed to have some side effects.  The side effects are considered mild, but, having more than 30% of subjects having a side effect becomes problematic, and more than 60% is particularly troubling.  We construct a utility function to represent this belief (higher values are better)

```{r}
risk_fun <- approxfun(c(0, 0.3, 0.6, 1), c(1, 0.9, 0.2, 0))
curve(risk_fun, xlab = "Side-Effect Rate", ylab = "Risk Utility Function")
```

Since the side effects are mild, we will assign greater weight on ensuring that the drug works (75%) and a lower weight on the side effects (25%).  Therefore, if an arm in the clinicial trial had a known "true" response rate of 60% and a side-effect rate of 10%, the benefit-risk value would be

```{r}
.75 * benefit_fun(0.60) + 0.25 * risk_fun(0.10)
```

whereas an arm with a "true" 10% benefit and 80% side-effects would have a lower score of

```{r}
.75 * benefit_fun(0.10) + 0.25 * risk_fun(0.80)
```

In practice, we don't actually know the "true" response rates or side effect rates, so including uncertainty in the estimate based on the data helps us to better quantify the amount of evidence for or against a new treatment.  A natural way to do this is through a Bayesian analysis.  Given samples from the Bayesian posterior (based on data), we can estimate the uncertainty in the benefit-risk score of each treatment arm.

Suppose we had 100 patients each in the placebo and treatment arms of the study.  Suppose that 5 responded on the placebo arm and 55

```{r}
library(brisk)
set.seed(1132)
out <- br(
  benefit("response", benefit_fun, weight = .75),
  risk("side_effect", risk_fun, weight = .25),
  br_group(
    label = "placebo",
    response = rbeta(1e4, 1 + 30, 1 + 70),
    side_effect = rbeta(1e4, 1 + 3, 1 + 97)
  ),
  br_group(
    label = "drug",
    response = rbeta(1e4, 1 + 60, 1 + 40),
    side_effect = rbeta(1e4, 1 + 40, 1 + 60)
  )
)

plot(out)
# adjusted relative to PBO
plot(out, reference = "placebo")

plot_utility(out)
plot_utility(out, reference = "PBO")
plot_utility(out, stacked = TRUE)
```
